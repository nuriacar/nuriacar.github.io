---
layout: post
title:  Virüs yazmak için hangi programlama dilleri kullanılır? [Siber Güvenlik]
date:   2022-04-06 12:00:00 +0000
categories: cevizlab
---

Hamiline,

İşbu yazı ve dahi tüm site içeriği, ben öğrendikçe kendini evriltecektir. Mevzubahis "malware" ve türleri, şahsi lügatimde olduğu haliyle yer yer "silah" ya da "sanat eseri" olarak adlandırılacaktır.

İmza: Bir Dost

---

## Soru: Malware kodlarken hangi programlama dillerini kullanmak mantıklıdır? Hangilerini kullanmak değildir? Neden?

Genele hitap etmesi açısından bu soruyu şöyle soralım: **Virüs yazmak için hangi programlama dilleri kullanılır?**

**Not:** Her ne kadar çok tıklansın diye bu yazının başlığını "**Virüs yazmak için hangi programlama dilleri kullanılır?**" olarak girsem de yazı içeriği; ulema, cühela ve ehli dubara'yı; ehli namus, ehli işret ve erbab-ı livata'yı tatmin edecek haldedir. İlan, hikayet ve beyan olunur!

### Havadis

[Bir milyar malware, kablolarda cirit atıyor](https://dataprot.net/statistics/malware-statistics/). Tüm bunların kaynak kodunu inceleyip istatistik tutmadım lakin yazılanlara göz atacak olursam durum şu: Malware'lerin %53'ü `.exe`. Peşine %6 ile `.pdf` geliyor. Tüm bunlar ise tamamen hükümran platformla alakalı. Windows yaygın. Haliyle `.exe`...

C veya C++ ile `.exe` derlenebilir lakin C, C++'dan daha tercih edilesi. Malware yazacaksanız, C++'daki dinamik bellek yönetimi ayağınıza dolanıyor. Bunun yanında C++ kodunuz yazdığınız zamanda çalışıyor olsa da yarın bir gün [STL](https://en.wikipedia.org/wiki/Standard_Template_Library)'de bir şeyleri değiştirseler çalışmıyor. C++ bence bir çöplük (eskilerin tabiriyle "piç" dil) ve sağlıklı insan zihnini bozuyor.

Her `.exe` oluşturan dil işe yarar diye bir durum da yok. Final dosya boyununun mümkün olduğunca küçük olması, Windows özelinde bakacak olursak [Windows API](https://docs.microsoft.com/en-us/windows/win32/) ile konuşabiliyor olması ve bağımlılıklarının (.Net) olmaması gerek. Final dosya boyutu için bir örnek vereyim: C/C++/ASM ile kodlanan zararlı 100kb'tan ufak bir PE (Portable Executable) oluyorken aynı işi yapan Golang PE'i minimum 800kb oluyor. Sekiz katı daha fazla... 

Eskiler 1990'a kadar coğunlukla Assembly ve Common Lisp ile malware kodladıklarından bahsediyorlar. Dediklerine göre Morris Worm, C ile yazılmış ilk malware. Bunun yanında, malware yazarken tercih edilecek dilin içine Assembly gömebiliyor olmak (C, Turbo Pascal, Delphi vs.) büyük bir artı.

[Söz Delphi'ye gelmişken bahsetmek istediklerim var](https://threatpost.com/delphi-packer-looks-for-human-behavior-before-deploying-payload/137609/): "Delphi de neymiş!" demeyin zira Delphi ile çok fazla malware yazılıyor. İşin içibe BobSoft Packer'ı ile paketleme ve normal kullanıcı davranışı analizi ve simülasyonu girince de malware tespiti ve analizi zorlaşıyor. [Hatırlarsanız MEB, 2020 yılında Embarcadero'dan bir milyon Delphi lisansı almıştı](https://www.meb.gov.tr/1-milyon-meslek-lisesi-ogrencisine-yazilim-egitimi/haber/20138/tr). Öğrenenlerin %0.1'inin malware kodladığını düşünün. Let the sunshine in babe...

<iframe width="560" height="315" src="https://www.youtube.com/embed/kjxSCAalsBE?start=137" title="YouTube video player" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe>

Peki ya [Rust, DLang ve Nim dilleriyle yapılabileceklere ne demeli?](https://www.bleepingcomputer.com/news/security/trickbots-bazarbackdoor-malware-is-now-coded-in-nim-to-evade-antivirus/) "C öğrendim, bitti, bu bana yeter!" demek anlamsız. Güvenlik araçlarından saklanmak için bu dillerdeki yenilikleri denemek ve böylece bir adım önde olmak mümkün. Örneğin C ile kodlanmış eski ve yakalanan bir malware, [Rust](https://www.rust-lang.org/)'a ya da [Nim](https://nim-lang.org/)'e sarılarak Stege I'de başarıyla sahne alabiliyor. Koyun postu giymiş kurt... Peki neden? Bir dilde tersine mühendislik ne kadar zorsa, o dilde malware geliştirmek için o kadar iyi!

![Kuzu Kurdun, Yol Ford'un](/assets/img/wolf-in-sheeps-clothing.jpg "Kuzu Kurdun, Yol Ford'un")

Madem malware konuşuyoruz; [Self-modifying Code](https://en.wikipedia.org/wiki/Self-modifying_code), [Polymorphic Code](https://en.wikipedia.org/wiki/Polymorphic_code) ve [Metamorphic Code](https://en.wikipedia.org/wiki/Metamorphic_code) meselelerini de hatırlatmak istiyorum. Her dil bunları desteklemiyor.

> Ben malware'e malware demem
> 
> Self-modifying, Polymorphic ve dahi Metamorphic olmayınca
> 
>> Karacaoğlan

Şimdi de genel malware türlerine bakalım ve ardından yeni başlıkla birlikte daha da derinlere dalalım:

1. Virus
2. Worm
3. Trojan, RAT
4. Rootkit
5. Ransomware
6. Logger
7. Grayware
8. Botnet
9. Spyware
10. Adware

Tüm bunları hedef ortamınıza göre çeşitli dillerle gerçekleyebilirsiniz lakin özelde dikkat çekmek istediğim şöyle bir durum var: Rootkit yazacaksanız kesinlikle Assembly lazım. Zira bunun [device driver](https://en.wikipedia.org/wiki/Device_driver) yazmaktan farkı yok. [Ransomeware yazacaksanız da encryption hızı en yüksek algoritmayı yazacağınız dili seçmeniz lazım.](https://www.splunk.com/en_us/pdfs/resources/whitepaper/an-empirically-comparative-analysis-of-ransomware-binaries.pdf)

Ransomware hakkında konudan alakasız olarak öğrendiğim bir bilgiden bahsedeyim: Herhangi bir saldırının farkedilmesi altı ayı bulabiliyor. Altı aydır sistemde farkedilmeden gezen, alacağını almış, yükünü tutmuş saldırgan, sistemden çıkarken Ransomware basıp çıkıyor. Bir nevi "Çilli horozu yedik, suyuna da pilav pişirelim" der gibi..

Buraya kadar yazdığım genel geçer şeyler cevap olarak yetmez zira bence bu sorunun cevabı;

+ amacınız ve zaman kısıtınızla,
+ yalnız mı yoksa ekip olarak mı çalıştığınızla,
+ zararlı yazılımı kullanmak istediğiniz süreyle,
+ hedef sistem ve saldırınızın hangi safhasında olduğunuzla doğrudan alakalı.

### Amaç ve Zaman

[Yüzlerce programlama dili var.](https://en.wikipedia.org/wiki/List_of_programming_languages) Diğer pek çok şey gibi programlama dilleri de ihtiyaca binaen doğarlar ve [her ne kadar benzer işi yapıyor görünseler de yetkinlikleri farklı](https://en.wikipedia.org/wiki/Comparison_of_programming_languages). Programlama dili seçimi ise bana daha çok din seçimi gibi geliyor. Ortalık, aşina olduğu programlama dilini yaymaya çalışan [sahte peygamberlerle](https://en.wikipedia.org/wiki/False_prophet) dolu. C'yi geliştiren [Dennis Ritchie](https://en.wikipedia.org/wiki/Dennis_Ritchie) bile C'den başka diller de geliştirmişken huzur verin paşam! Aslanların işini hangi dil optimum görüyorsa onu seçsinler. Zira [Bane](https://batman.fandom.com/wiki/Bane_(Nolanverse)) maskesi ile lokum yiyemeyeceğiniz gibi, Tantra Chair'la da sığ ve zevksiz iş yapamazsınız.

Geliştirme için harcayacağınız zaman da önemli. [Sir Tim Barnes-Lee](https://tr.wikipedia.org/wiki/Tim_Berners-Lee) gibi [Objective-C ile web işleri yapar ve hatta bunu NFT olarak satarsınız](https://www.sothebys.com/en/buy/auction/2021/this-changed-everything-source-code-for-www-x-tim-berners-lee-an-nft/source-code-for-the-www) lakin kodlamak için harcadığınız onca vakte yazık. Zira Objective-C öğrenene kadar 50 tane Django işi yapar, üçe beşe bakmaz ekmeğinizi kazanırsınız.

Sizi, amacınıza belirlenen zamanda ulaştıracak optimum dil tercih edilmeli. Bu da eldekiyle yetinmeyen, araştırmacı, yeniliğe açık, öğrenmeye ve evrilmeye meraklı bir bilinç olmakla mümkün.

### Solo? Koro?

Malware'lerin türüne göre çeşitli özellikleri var. Benim gibi Yalnız Kurt modundaysanız ve aklınızdakileri yapabiliyor ya da yapamadığınızda oturup öğrenmeye koyuluyorsanız, optimum dilinizle ya da dillerinizle at koşturabilirsiniz.

Ekip olarak çalışıyorsanız ortak dil/diller belirlemeli, [kod standardı ve kalitesi oluşturmalısınız](https://www.kernel.org/doc/html/v4.10/process/coding-style.html). Koro olarak yapılan tüm işlerde, herhangi birinin bilerek ya da bilmeyerek bırakabileceği en ufak bir zafiyetin işi akamete uğratacağını ve hatta sizi yakalatacağını da hatırlatmakta fayda var.

Buna ek olarak dikkat edilmesi gereken bir konu daha var: Solo veya koro farketmeksizin [Lengüistik](https://sozluk.gov.tr/), [Unabomber](https://www.fbi.gov/history/famous-cases/unabomber)'ı yakalattığı gibi sizi de yakalatabilir.

![Sincerely yours, Ted Kaczynski](/assets/img/unabomber.jpg "Sincerely yours, Ted Kaczynski")

### Malware Amortismanı

Malware'e biçtiğiniz amortismanı da göz önünde bulundurmak gerek. Terzi işi yani çok özel üç beş hedefte kullanacağınız, dokunduğunu affetmeksizin kesen ve bu çok özel üç beş hedeften sonra emekliye ayıracağınız [sanat eserleri](https://github.com/nuriacar/logger) başka; uzun süre boyunca kullanmayı hedeflediğiniz ve zaman içinde evrilteceğiniz şeyler kodlayacaksanız başka yollar izlemelisiniz. Uzun süreli kullanımlar için, yalnızca spesifik bir işi yapan modüllere ayrılmış, modüler bir zararlı ailesi kodlamak optimumdur. Olur da farkedilirseniz, yalnızca yakalanan modülü yeniden kodlamanız işinizi sürdürmenizi sağlar. Bunu tüm aracı değil yalnızca bozulan parçayı değiştirmek gibi düşünebilirsiniz. Bu, "terzi işi silahlar modüler şekilde kodlanmaz" demek değil! **İşi ne ka minimal delege ederseniz o ka iyi!**

### Hedef Sistem ve Saldırı Safhası

Tarayıcıya üzerinden id/email, parola, kredi kartı bilgileri veya cookie gibi bilgileri hedefliyorsanız JavaScript veya süpersetleri optimum. Windows veya Linux'te bir şeyler yapacaksanız x86 Assembly/C/C++, Apple'da Objective-C, Android'de Java veya NDK ile C++ ...

Bunun yanında Windows'da, `.sh`, `.py`, `.pl` vs. zararlılarınız MinGW, Cygwin veya kodladığınız dilin yorumlayıcısı yoksa çalışmaz. `.bat` veya `.ps1` zararlılarınız da [Unix-like OS](https://tr.wikipedia.org/wiki/Unix_benzeri)'larda çalışmaz.

APT gruplarına baktığımızda görünen şu: Her safha için kullanılan araç ve kodlandığı dil farklı. [APT29 üzerinden örnekleyeyim](/cevizlab/2022/04/04/apt29-adversary-emulation.html):

Phishing epostası ekine MS Office belgesi koyuyor, içine `.vbs` gömüyorlar. Reverse Shell'le C2'ya erişip C2 üzerinden hedef sistemde `.bat` ve `.ps1` çalıştırıyorlar. Eğer işlerini Windows'da default gelen WMI ya da Sysinternals araçlarıyla yapabiliyorlarsa gizliden gitmek için onlarla yapıyor (LotL: Fileless Attack), yapamıyorlarsa geliştirdikleri `.exe` araçları sisteme dağıtıyorlar.

Görünen o ki hedef platformda o an işlerini görecek optimum aracı kodlayabilecekleri dil hangisiyse o dille kodluyorlar.

Phishing mailine ekli MS Office dokümanı içine `.vbs` payload gömmek alışılagelen bir şey. Peki ya AutoDesk AutoCAD'in kullandığı [Common Lisp](http://landoflisp.com/) diyalekti olan [AutoLisp](https://en.wikipedia.org/wiki/AutoLISP)'le zararlı yazıp [sanayi hırsızlığı yapmak?](https://arstechnica.com/information-technology/2018/11/malware-targeting-autocad-is-infecting-companies-all-around-the-world/)

Dahası da var! Karşınızda elli yıl önce [COBOL](https://en.wikipedia.org/wiki/COBOL) üzerine inşa edilmiş ve hala çalışan bir [bankacılık ya da sağlık sistemi mainframe'i](https://techchannel.com/Enterprise/03/2021/business-systems-cobol) varsa? CERN'ün gülü [FORTRAN](https://fortranwiki.org/fortran/show/CERNLIB)'a ne demeli? Veya hedef, üzerinde [Sel4 mikrokernel](https://sel4.systems/) koşturan [tam güvenli](https://www.linkedin.com/pulse/sel4-unhackable-kernel-keeping-all-computers-safe-from-agnihotri) bir [DARPA dronu](https://trustworthy.systems/projects/TS/SMACCM/) ya da [%99'u Ada üzerine kurulu bir Boeing uçağıysa](http://archive.adaic.com/projects/atwork/boeing.html)? Ya da süper bilgisayarlarda veya NASA'nın gönderdiği uydularda çoğunlukta olduğu gibi, hedef sistem aslında [state of the art](https://en.wikipedia.org/wiki/State_of_the_art) bir [Lisp makinesi](https://en.wikipedia.org/wiki/Lisp_machine)yse?

Hatırlatmakta fayda var: Oğuz budununun [ALGOL](https://en.wikipedia.org/wiki/ALGOL) boyunun yaman delikanlısı [C ve torunları](https://wiki.c2.com/?AlgolFamily) çoğu işlemci ailesinde çalışır ama her işlemci ailesinde çalışmaz. "C'yi anladık eyvallah lakin peki ya Assembly?" diye soracak olanları merakta bırakmamak adına yazayım: [Üretimde olan kırktan fazla farklı işlemci mimarisi var ve her birinin Assembly'si birbirinden farklı.](https://www.quora.com/How-many-types-assembly-languages-are-active-today-Are-there-more-than-two-which-are-ARM-and-Intel)

---

## Soru: Yazılan malware kodlarına AV/EDR/XDR atlatma amacıyla neler eklenebilir?

![Windows Kernel-mode User-mode](/assets/img/windows-usermode-kernelmode.jpg "Windows Kernel-mode User-mode")

AV/EDR'lar da Windows'a sonradan kurulan programlar gibi **User-mode**'da çalışır. İşletim sistemi çekirdeği ve device driver'larsa **Kernel-mode**'da... **User-mode**'daki uygulamalar, **Kernel-mode**'daki bellek bölümlerine erişemez veya bunları değiştiremez. AV/EDR sistemleri, [Kernel Patch Protection](https://en.wikipedia.org/wiki/Kernel_Patch_Protection) nedeniyle yalnızca **User-mode**'daki uygulama davranışını izleyebilir. **User-mode**'dan **Kernel-mode**'a geçişte son kapı, yukarıdaki görselde de göreceğiniz gibi `ntdll.dll`'deki Windows API fonksiyonları. `ntdll.dll`'den herhangi bir fonksiyon çağrılırsa (`syscall`), CPU, AV/EDR tarafından izlenemeyen ve haliyle loglanmayan **Kernel-mode**'a geçer. [Böylece AV/EDR bypass edilebilir](https://outflank.nl/blog/2019/06/19/red-team-tactics-combining-direct-system-calls-and-srdi-to-bypass-av-edr/).

Bunun yanında her bir endpoint'de milyarlarca log oluşur ama EDR'lar bu logların hepsiyle başa çıkamaz. Oluşan aktivitelerin tamamıyla ilgilenemez, doğaları gereği en önemlileri hariç filtrelerler. SOC ekibi de filtreye takılanların olsa olsa %50'sini ya farkeder ya farketmez. Haliyle bir malware, kertenkelenin kuyruğunu bırakması gibi, yüksek risk seviyesinde sahte bir alarm ya da çeşitli seviyelerde alarmlar ürettirerek tüm SOC'yi önemsiz bir şeye odaklayarak pazara gönderebilir. Onlar kertenkelenin kuyruğuyla oynarken malware, asıl yapması gerekenleri gerçekleştirebilir.

Şunu yapmak da mümkün: XP'den beri Windows güncellemeleri, BITS yani [Background Intelligent Transfer Service](https://docs.microsoft.com/en-us/windows/win32/bits/about-bits) üzerinden dağıtılır. Öyle ki tüm Windows sistemler güncelleme için Microsoft sunucularına bağlanmazlar, yakınlarında bir yerde olan ve güncellemeleri almış başka bir Windows makine üzerinden güncelleme alırlar. Bunu şu şekilde kullanarak AV/EDR atlatabilirim: Malware dağıtacaksam BITS paketleri içinde Windows Update olarak dağıtabilirim. Malware download edeceksem de doğrudan AV/EDR tetikleyecek olan download şeklinde değil de BITS isteği yaparak halihazırda üzerinde at koşturduğum sisteme indirip Windows güncellemesiymiş gibi kurulum sağlayabilir, Stage II'ye geçebilirim. Üstelik tüm bu işlemler sırasında data aktarımı yaparken bant genişliğini sömürmeksizin yalnızca uygun olduğu kadar kullanarak stealth kalabilir, EDR'ın onca logla uğraşamayacağı için kendiliğinden filtrelediği hayalet loglar arasında operasyonumu sürdürebilirim.

<iframe width="560" height="315" src="https://www.youtube.com/embed/qtXUhinRWoI" title="YouTube video player" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe>

**Not:** Tüm bunları yapamıyorsan, EDR'a yakalanmamak için ne yap et, eriştiğin sistemdeki kullanıcıymış gibi davran, anormal kullanıcı etkinliği oluşturmamaya çalış.
